<div class="produits-container">
  <div class="produits-header">
    <div class="header-left">
      <h1>Tous les Produits</h1>
      <p class="subtitle">{{ totalElements }} produit(s) au total</p>
    </div>

    <div class="header-right">
      <!-- Recherche -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechercher</mat-label>
        <input
          matInput
          [(ngModel)]="searchQuery"
          (keyup.enter)="rechercher()"
          placeholder="Nom du produit..."
        />
        <mat-icon matPrefix>search</mat-icon>
        <button
          mat-icon-button
          matSuffix
          *ngIf="searchQuery"
          (click)="clearSearch()"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <!-- Filtre statut -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Statut</mat-label>
        <mat-select [(ngModel)]="filtreStatut" (selectionChange)="appliquerFiltre()">
          <mat-option value="">Tous</mat-option>
          <mat-option value="APPROUVE">Approuvés</mat-option>
          <mat-option value="EN_ATTENTE">En attente</mat-option>
          <mat-option value="REJETE">Rejetés</mat-option>
          <mat-option value="SUSPENDU">Suspendus</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="loadProduits()">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Loader -->
  <div class="loading-container" *ngIf="loading && produits.length === 0">
    <mat-spinner></mat-spinner>
    <p>Chargement des produits...</p>
  </div>

  <!-- Liste vide -->
  <mat-card class="empty-state" *ngIf="!loading && produits.length === 0">
    <mat-icon>inventory_2</mat-icon>
    <h2>Aucun produit trouvé</h2>
    <p>{{ searchQuery ? 'Essayez une autre recherche' : 'Aucun produit disponible' }}</p>
  </mat-card>

  <!-- Tableau -->
  <mat-card class="table-card" *ngIf="produits.length > 0">
    <table mat-table [dataSource]="produits" class="produits-table">

      <!-- Image -->
      <ng-container matColumnDef="image">
        <th mat-header-cell *matHeaderCellDef>Image</th>
        <td mat-cell *matCellDef="let produit">
          <img
            [src]="'http://localhost:8080/' + produit.photoUrl"
            [alt]="produit.nom"
            class="produit-thumbnail"
            (error)="onImageError($event)"
          />
        </td>
      </ng-container>

      <!-- Nom -->
      <ng-container matColumnDef="nom">
        <th mat-header-cell *matHeaderCellDef>Nom</th>
        <td mat-cell *matCellDef="let produit">
          <div class="produit-nom-cell">
            <strong>{{ produit.nom }}</strong>
            <span class="categorie">{{ produit.categorieNom }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Prix -->
      <ng-container matColumnDef="prix">
        <th mat-header-cell *matHeaderCellDef>Prix</th>
        <td mat-cell *matCellDef="let produit">
          <span class="prix">{{ produit.prix | number:'1.0-0' }} FCFA</span>
        </td>
      </ng-container>

      <!-- Vendeur -->
      <ng-container matColumnDef="vendeur">
        <th mat-header-cell *matHeaderCellDef>Vendeur</th>
        <td mat-cell *matCellDef="let produit">
          <div class="vendeur-cell">
            <span class="nom">{{ produit.vendeurNom }}</span>
            <span class="ville" *ngIf="produit.vendeurVille">{{ produit.vendeurVille }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Statut -->
      <ng-container matColumnDef="statut">
        <th mat-header-cell *matHeaderCellDef>Statut</th>
        <td mat-cell *matCellDef="let produit">
          <mat-chip [class]="'status-' + produit.statut.toLowerCase()">
            {{ getStatutLabel(produit.statut) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Vues -->
      <ng-container matColumnDef="vues">
        <th mat-header-cell *matHeaderCellDef>Vues</th>
        <td mat-cell *matCellDef="let produit">
          <div class="vues-cell">
            <mat-icon>visibility</mat-icon>
            <span>{{ produit.nombreVues }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Date -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let produit">
          {{ produit.dateCreation | date:'dd/MM/yyyy' }}
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let produit">
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            [matMenuTriggerData]="{ produit: produit }"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

    </table>
  </mat-card>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="totalElements > 0"
    [length]="totalElements"
    [pageSize]="pageSize"
    [pageIndex]="currentPage"
    [pageSizeOptions]="[10, 20, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons
  ></mat-paginator>
</div>

<!-- Menu contextuel -->
<mat-menu #menu="matMenu">
  <ng-template matMenuContent let-produit="produit">

    <button mat-menu-item (click)="voirDetail(produit.id)">
      <mat-icon>visibility</mat-icon>
      <span>Voir les détails</span>
    </button>

    <button
      mat-menu-item
      *ngIf="produit.statut === 'EN_ATTENTE' && isModerator"
      (click)="moderer(produit.id)"
    >
      <mat-icon>pending_actions</mat-icon>
      <span>Modérer</span>
    </button>

    <mat-divider *ngIf="isAdmin"></mat-divider>

    <button
      mat-menu-item
      *ngIf="isAdmin"
      (click)="supprimerProduit(produit)"
    >
      <mat-icon color="warn">delete</mat-icon>
      <span>Supprimer</span>
    </button>

  </ng-template>
</mat-menu>
